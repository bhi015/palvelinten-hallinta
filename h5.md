
Tämä on raportti tehdystäni miniprojektista Palvelinten-hallinta kurssilla.

### Mikä on projektini
Moduulini tarkoitus on luoda webb palvelin joka pyrörii Nginx avulla. Itse haaste ja maali projektissa oli luoda tämä webb palvelin keskitetyllä hallinnalla ja infra koodina.

### Mitä sivulla voi tehdä?
Sivu käyttää avuksi Geolocation API jonka avulla palvelin löytää kordinaattisi. Ja painamalla linkkiä sivulla näet oman sijaintisi kartalla

# Oma moduuli
Kaikki alkaa tyhjältä pöydältä ainoa mitä minulla on, on kaksin konetta `master` ja `minion` joihin on konffattu salt (en tässä raportissa selittää miten konffataan, löytyy aijemista tehtävistä).

Ideana on että pystyn suoraan masterilta ajamaan kaksi valmiiksi tehdyt sls tiedostot, ja nopeasti pystytäämään Nginx webb palvelimen vaikka sadalla koneella.

Voit myös helposti muuttaa itse html koodia saadaksesi minkälaisen sivun tahansa mille koneelle tahansa.

## Valmiit sls koodit

    nginx:
      pkg.installed
    
    create_directory:
      file.directory:
        - name: /var/www/geolocation
    
    index_creation:
      file.managed:
        - name: /var/www/geolocation/index.html
        - contents: |
            <!DOCTYPE html>
            <html>
            <head>
                    <title>Nginx Web Server</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" contents="width=device-width, initial-scale-1.0">
            </head>
            <body>
                    <h1>Hello and welcome to my Nginx web server!</h1>
                    <h2>This Web server was created by Linus Kumpunen, for my mobule project</h2>
                    <h3>On this page you can get your location using Geolocation API</h3>
                    <h4>Note! This page only works if you give the website persmission to access your location</h4>
                    <div id="cordoutput"></div>
            </body>
            <script>
                    if (!navigator.geolocation) {
                            throw new Error("No geolocation available");
                    }
                    function success(pos) {
                            console.log(pos);
                            const lat = pos.coords.latitude;
                            const lng = pos.coords.longitude;
                            const markup = `
                            <a href="https://www.openstreetmap.org/#map=16/${lat}/${lng}">Your location is: latitude: ${lat}, longitude: ${lng}. Open link to see on map.</a>
                            `;
                            document.getElementById("cordoutput").innerHTMl = markup;
                    }
                    function error(err) {
                            console.log(err);
                            if (err.code == 1) {
                                    alert("Please allow access to geolocation");
                            } else {
                                    alert("Position unavailable");
                              }
                    }
                    const options = {
                        timeout: 5000,
                    };
                    navigator.geolocation.getCurrentPosition(success, error, options);
            </script>
            </html>
    
    geo_conf_creation:
      file.managed:
        - name: /etc/nginx/sites-available/geolocation_conf
        - contents: |
            server {
                    listen 80;
                    server_name localhost;
    
                    root /var/www/geolocation;
                    index index.html;
    
                    location / {
                                try_files $uri $uri/ =404;
                    }
                   }
    
    
    site_enable:
      cmd.run:
        - name: sudo ln -s /etc/nginx/sites-available/geolocation_conf /etc/nginx/sites-enabled
    
    site_disable:
      cmd.run:
        - name: sudo unlink /etc/nginx/sites-enabled/default
    
    nginx_enable:
      cmd.run:
        - name: sudo systemctl start nginx && sudo systemctl enable nginx

Tämä on sls tiedoston joka:

- Lataa Nginx
- Luo uuden html siuvn
- html tiedostoon lisää html koodin sivua varten
- Luo sivun konfiguraatio tiedoston
- Lisää tiedostoon itse konffauksen
- Käynnistää ja aktivoi sivun


        generate_ssl_certificate:
          cmd.run:
            - name: |
                openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
                -keyout /etc/ssl/private/geolocation.key \
                -out /etc/ssl/certs/geolocation.crt \
                -subj "/C=US/ST=State/L=City/O=Organization/OU=Unit/CN=example.com"
            - creates: /etc/ssl/private/geolocation.key
        
        add_ssl_to_nginx:
          file.replace:
            - name: /etc/nginx/sites-available/geolocation_conf
            - pattern: '(server\s*{[^}]*?)'  # Matches the opening server block
            - repl: |
                \1
                ssl_certificate /etc/ssl/certs/geolocation.crt;
                ssl_certificate_key /etc/ssl/private/geolocation.key;
                listen 443 ssl;
            - append_if_not_found: False
        
        reload_nginx:
          service.running:
            - name: nginx
            - watch:
                - cmd: generate_ssl_certificate
                - file: add_ssl_to_nginx

  Tämä sls tiedosto on ssl varten ja:

- Luo uuden ssl avaimen
- lisää sen konffaus tiedostoon
- Avaa tarvittavat portit
